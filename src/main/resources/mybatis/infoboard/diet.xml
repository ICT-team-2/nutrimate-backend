<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nutrimate.nutrimatebackend.mapper.infoboard.DietMapper">
	  <select id="findAllDietBoard" resultType="dietDto" parameterType="dietDto">
					SELECT * FROM (
       				 SELECT DISTINCT user_nick,b.*,COUNT(bl.like_id) OVER (PARTITION BY b.board_id) likecount, CEIL(((select count(*) from foodboard)/10)) totalPage,
                    RANK() OVER (ORDER BY b.board_id desc) AS label 
                    FROM board b
                    LEFT JOIN boardlike bl ON b.board_id=bl.board_id
                    JOIN member m ON m.user_id= b.user_id
                    WHERE b.blocked='N' AND b.deleted='N' AND b.board_category = 'FOOD'
                    <if test="searchUser !=null">
                        AND m.user_nick LIKE '%' || #{searchUser} || '%'
                    </if>	
                    <if test="searchTitle !=null">
                        AND b.board_title LIKE '%' || #{searchTitle} || '%'
                    </if>
                    ORDER BY b.board_id DESC
                    
                    ) WHERE label BETWEEN (#{nowPage}-1)*10+1 AND #{nowPage}*10
                    
		</select>
		
		<update id="updateViewCountByBoardId" parameterType="dietDto">
		    UPDATE board SET board_viewcount=(SELECT board_viewcount FROM BOARD WHERE board_id=#{boardId})+1 WHERE board_id=#{boardId}
		</update>
		
		<select id="findDietBoardOne" resultType="dietDto" parameterType="dietDto">
			SELECT DISTINCT user_nick,b.*,fb.*,f.food_cal,f.intake_unit,f.food_intake,COUNT(bl.like_id) OVER (PARTITION BY b.board_id) likecount
			FROM board b JOIN FoodBoard fb ON b.board_id = fb.board_id JOIN food f ON fb.food_id=f.food_id 
			LEFT JOIN boardlike bl ON fb.board_id=bl.board_id
			JOIN member m ON m.user_id= b.user_id
			WHERE b.blocked='N' AND b.deleted='N' AND b.board_id=#{boardId}
		</select>
		
		<insert id="insertBoard" parameterType="dietDto">
		 <selectKey keyProperty="boardId" resultType="int" order="BEFORE">
		        SELECT SEQ_BOARD.NEXTVAL FROM DUAL
		 </selectKey>
		    INSERT INTO board VALUES(SEQ_BOARD.CURRVAL,#{userId},'FOOD',#{boardTitle},#{boardContent},DEFAULT, 0, sysdate, DEFAULT, DEFAULT)
		</insert>
		<insert id="insertFoodBoard" parameterType="dietDto">
			INSERT INTO foodboard VALUES(#{boardId},#{foodId},#{fbImg})
		</insert>
		<update id="updateBoardByboardId" parameterType="dietDto">
		    UPDATE board SET board_title=#{boardTitle},board_content=#{boardContent}  WHERE board_id=#{boardId}
		</update>
		<update id="updateFoodBoardByboardId" parameterType="dietDto">
		    <if test="fbImg !=null">
		    UPDATE foodboard SET food_id=#{foodId},fb_img=#{fbImg} WHERE board_id=#{boardId}
		    </if>
		    <if test="fbImg ==null">
		    UPDATE foodboard SET food_id=#{foodId} WHERE board_id=#{boardId}
		    </if>
		</update>
		
		<update id="updateBoardDeleteByBoardId" parameterType="dietDto">
		 UPDATE board SET deleted='Y' WHERE board_id=#{boardId}
		</update>
		
		<select id="findLikeBoardContByBoardIdAndUserId" resultType="int" parameterType="dietDto">
			select count(*) from boardlike where board_id=#{boardId} AND user_id=#{userId}
		</select>
		<insert id="InsertLikeBoardContByBoardIdAndUserId" parameterType="dietDto">
			INSERT INTO boardlike VALUES(SEQ_LIKE.NEXTVAL,#{boardId},#{userId},SYSDATE)
		</insert>
		<delete id="DeleteLikeBoardContByBoardIdAndUserId" parameterType="dietDto">
			DELETE boardlike WHERE board_id=#{boardId} AND user_id=#{userId}
		</delete>
		
		
		<select id="findPrevByBoardId" resultType="dietDto" parameterType="dietDto">
		<![CDATA[
			SELECT board_id,board_title FROM board WHERE board_id=(SELECT MIN(board_id) FROM board WHERE board_id > #{boardId} AND blocked='N' AND deleted='N') AND BOARD_CATEGORY='FOOD'
			]]>
		</select>
		
		<select id="findNextByBoardId" resultType="dietDto" parameterType="dietDto">
		<![CDATA[
			SELECT board_id,board_title FROM board WHERE blocked='N' AND deleted='N' AND board_id=(SELECT MAX(board_id) FROM board WHERE board_id < #{boardId}) AND BOARD_CATEGORY='FOOD'
			]]>
		</select>
		
		<select id="findBookMarkByBoardIdANDuserId" resultType="int" parameterType="dietDto">
			select count(*) from bookmark where board_id=#{boardId} AND user_id=#{userId}
		</select>
		<insert id="InsertBookMarkByBoardIdANDuserId" parameterType="dietDto">
			INSERT INTO bookmark VALUES(#{userId},#{boardId},SYSDATE)
		</insert>
		<delete id="DeleteBookMarkByBoardIdANDuserId" parameterType="dietDto">
			DELETE bookmark WHERE board_id=#{boardId} AND user_id=#{userId}
		</delete>
		

</mapper>