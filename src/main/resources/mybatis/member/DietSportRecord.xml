<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.nutrimate.nutrimatebackend.mapper.test.DietSportRecordMapper">

	<!-- 음식 목록 가져오기 -->
    <select id="findFoodList" resultType="DietSportRecordDto">
        SELECT * FROM food
        <!-- 검색 추가시 사용 -->
        <!-- WHERE food_name LIKE '김%'; -->
    </select>

    <!-- 자신이 먹은 음식 기록하기 (식단DB 데이터 사용) -->
    <insert id="insertRecord" parameterType="DietSportRecordDto">
	    <selectKey keyProperty="recordId" resultType="int" order="AFTER">
	        SELECT SEQ_RECORD.CURRVAL FROM DUAL
	    </selectKey>
        INSERT INTO record VALUES (SEQ_RECORD.NEXTVAL, #{userId}, SYSDATE, DEFAULT) <!-- 기록 공통 -->
    </insert>
    <insert id="insertFoodRecord" parameterType="DietSportRecordDto">
    	<selectKey keyProperty="dietrecordId" resultType="int" order="AFTER">
	        SELECT SEQ_DIETRECORD.CURRVAL FROM DUAL
	    </selectKey>
        INSERT INTO dietrecord VALUES (
        SEQ_DIETRECORD.NEXTVAL, 
        (SELECT MAX(record_id) FROM record WHERE user_id=#{userId}), 
        (SELECT FOOD_ID FROM food WHERE FOOD_NAME=#{foodName}))
    </insert>
    
    <!-- 자신이 먹은 음식 기록하기 (유저가 직접 입력) -->
    <insert id="insertRecordFo" parameterType="DietSportRecordDto">
	    <selectKey keyProperty="recordId" resultType="int" order="AFTER">
	        SELECT SEQ_RECORD.CURRVAL FROM DUAL
	    </selectKey>
        INSERT INTO record VALUES (SEQ_RECORD.NEXTVAL, #{userId}, SYSDATE, DEFAULT) <!-- 기록 공통 -->
    </insert>
    <insert id="insertRecordFood" parameterType="DietSportRecordDto">
        INSERT INTO food (food_id, food_name, food_cal)
        VALUES ((SELECT COUNT(*) + 1 FROM food), #{foodName}, #{foodCal})
    </insert>
    <insert id="insertRecordCustomFood" parameterType="DietSportRecordDto">
        INSERT INTO customfood VALUES (
        (SELECT MAX(food_id) FROM food WHERE food_name = #{foodName}), 
        #{userId, jdbcType=INTEGER}, 
        SYSDATE)
    </insert>
    <insert id="insertCustomFoodRecord" parameterType="DietSportRecordDto">
    	<selectKey keyProperty="dietrecordId" resultType="int" order="AFTER">
	        SELECT SEQ_DIETRECORD.CURRVAL FROM DUAL
	    </selectKey>
        INSERT INTO dietrecord VALUES (SEQ_DIETRECORD.NEXTVAL, #{recordId}, (SELECT food_id FROM food WHERE food_name = #{foodName}))
    </insert>
    
    
    
    <!-- 먹은 칼로리와 일일 권장 칼로리 열람하기 -->
    <!-- (운동 정도에 따라 권장 칼로리를 바꿀 수 있도록) -->
    <select id="findFoodCaloriesByUserId" resultType="Integer">
        <!-- 오늘 먹은 칼로리 -->
        SELECT sum(food_cal) FROM food
        WHERE food_id = (
            SELECT food_id 
            FROM dietrecord
            WHERE record_id=(
                SELECT record_id FROM record
                WHERE user_id=#{userId}
                AND TRUNC(do_date) = TO_DATE(SYSDATE)
            )
        );
        <!-- 일일 권장 칼로리 -->
        SELECT user_cal FROM member
        WHERE user_id=#{userId};
    </select>
    
    
    <!-- 운동 목록 가져오기 -->
    <select id="findSportList" resultType="DietSportRecordDto">
        SELECT SPORT_ID AS sportId, SPORRT_NAME AS sportName, SPORT_MET AS sportMet FROM sport
        <!-- 검색 추가시 사용 -->
        <!-- WHERE sporrt_name LIKE '바%'; -->
    </select>
    
    <!-- 운동으로 소모한 칼로리를 기록하는 쿼리문 (운동DB 데이터 사용) -->
    <insert id="insertRecordExer" parameterType="DietSportRecordDto">
	    <selectKey keyProperty="recordId" resultType="int" order="AFTER">
	        SELECT SEQ_RECORD.CURRVAL FROM DUAL
	    </selectKey>
        INSERT INTO record VALUES (SEQ_RECORD.NEXTVAL, #{userId}, SYSDATE, DEFAULT) <!-- 기록 공통 -->
    </insert>
    <insert id="insertExerciseRecord" parameterType="DietSportRecordDto">
    	<selectKey keyProperty="exerciseId" resultType="int" order="AFTER">
	        SELECT SEQ_SPORTRECORD.CURRVAL FROM DUAL
	    </selectKey>
		INSERT INTO sportrecord VALUES (
			SEQ_SPORTRECORD.NEXTVAL,
		    (SELECT MAX(record_id) FROM record WHERE user_id=#{userId}),
		    (SELECT MAX(sport_id) FROM sport WHERE sporrt_name=#{sportName}),
		    (SELECT sport_met FROM sport WHERE sporrt_name=#{sportName}) * (1 / 60) * #{sportTime} * (SELECT user_weight FROM member WHERE user_id=#{userId}),
		    #{sportTime},
		    (SELECT user_weight FROM member WHERE user_id=#{userId})
		)
    </insert>
     
    <!-- 운동으로 소모한 칼로리를 기록하는 쿼리문 (유저가 직접 입력) -->
    <insert id="insertRecordSp" parameterType="DietSportRecordDto">
	    <selectKey keyProperty="recordId" resultType="int" order="AFTER">
	        SELECT SEQ_RECORD.CURRVAL FROM DUAL
	    </selectKey>
        INSERT INTO record VALUES (SEQ_RECORD.NEXTVAL, #{userId}, SYSDATE, DEFAULT) <!-- 기록 공통 -->
    </insert>
    <insert id="insertRecordSport" parameterType="DietSportRecordDto">
        INSERT INTO sport VALUES (
        (SELECT COUNT(*) + 1 FROM sport), 
        #{sportName}, 
        (#{sportCal} * 60) / ((SELECT user_weight FROM member WHERE user_id = #{userId}) * #{sportTime}))
    </insert>
    <insert id="insertRecordCustomSport" parameterType="DietSportRecordDto">
        INSERT INTO customsport VALUES (
	        (SELECT MAX(sport_id) FROM sport WHERE sporrt_name = #{sportName}),
	         #{userId}, 
	         SYSDATE)
    </insert>
    <insert id="insertCustomSportRecord" parameterType="DietSportRecordDto">
    	<selectKey keyProperty="exerciseId" resultType="int" order="AFTER">
	        SELECT SEQ_SPORTRECORD.CURRVAL FROM DUAL
	    </selectKey>
        INSERT INTO sportrecord VALUES (
	        SEQ_SPORTRECORD.NEXTVAL, 
	        #{recordId}, 
	        (SELECT MAX(sport_id) FROM sport WHERE sporrt_name = #{sportName}), 
	        #{sportCal}, 
	        #{sportTime}, 
	        (SELECT user_weight FROM member WHERE user_id = #{userId}))
    </insert>

    <!-- 오늘 자신이 소모한 칼로리를 열람하는 쿼리문 -->
    <select id="findExerciseCaloriesByUserId" resultType="Integer">
        SELECT SUM(sport_cal) FROM sportrecord
        WHERE record_id=(
            SELECT record_id FROM record
            WHERE user_id=#{userId}
            AND TRUNC(do_date)=TO_DATE(SYSDATE)
        );
    </select>
    
</mapper>